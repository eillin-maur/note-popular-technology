# Краткий экскурс по Kafka

## 1. Что такое и сценарии использования
Apache Kafka - распределенная, масштабируемая, централизованная система обмена сообщениями в режиме реального времени, которая дает возможность публикации потоков данных и подписки на них, их хранения и обработки.

Преимущества:
- горизонтальная масштабируемость путем добавления нод в кластер.
- отказоустойчивость за счет репликации партиций на ведомые ноды.
- безопасность за счет SSL-шифрования, различных вариантов авторизации, гарантий доставки сообщений и т.д.
- интегрируемость за счет Kafka Connect и собственного протокола на базе TCP, который легко взаимодействует с популярными протоколами передачи данных.
- гарантирует порядок доставки сообщений (FIFO).

Недостатки:
- клиенту нужно заботиться о вычитке сообщений (глупый брокер - умный консьюмер, pull-модель).
- ...

Используется в ситуациях, когда:
- нужно передавать одни и те же данные разным потребителям (вместо нескольких интеграций между системами и их поддержания, мы отливаем в Kafka один раз и даем возможность другим системам делать с ними, что угодно).
- нужно что-либо логгировать, ослеживать и обрабатывать в режиме реального времени (в том числе асинхронно).
- необходимо сохранять порядок чтения сообщений.
- необходимо обрабатывать большое количество данных.


## 2. Основные понятия
Сообщение - базовая единица данных (можно рассматривать как набор байт). Содержит ключ (не всегда) и сообщение. Ключ нужен, если нам нужна гарантия, чтобы сообщения с одним ключом вычитывались одним конкретным консьюмером из группы.

Пакет - группа сообщений (сообщения отправлять по одному невыгодно, поэтому они группируются в пакеты и отправляются пакетами).

Схема - соглашение о структуре сообщений. Обычно avro, так как не зависит от платформы и обеспечивает внутренюю совместимость. Хранятся в реестре схем (schema registry), там поддерживается версионность схем, когда структура сообщения меняется. Позволяет отправлять только сообщения, которые соответствуют схеме из реестра.

Топик - сегментированный append-only журнал, как правило, содержащий сообщения одной предметной области и единой схемы.

Партиция - логическое разделение сообщений в топике. Если не указывать ключ сообщения, то сообщение записывается сначала в 1-ю партицию, потом во 2-ю и т.д. (round-robin), но можно и указать конкретную партицию при записи. Сообщения с одним ключом попадают в одну и ту же партицию. Порядок сообщений в партиции сохраняется (до тех пор пока не добавится новая партиция). Партиции используются для распределения нагрузки между консьюмерами в пределах группы.

Оффсет - смещение сообщения относительно первого полученного в пределах партиции (можно рассматривать как индекс массива сообщений). Нужен для того, что консьюмеры знали, где они остановились читать и с какой позиции им нужно продолжить читать. Обычно хранятся в отдельном топике, но есть вариант сохранять во внешние системы. Главная проблема в атомарности обработки сообщения консьюмером и записи оффсета. Сохранение оффсета: автоматическое - например, раз в 5сек., ручное - консьюмер сам коммитит оффсет (бывает синхронное и асинхронное).

Брокер - нода Kafka, хранящая и обрабатывающая сообщения. Брокеры объединяются в кластер, где один брокер - контроллер. Контроллер нужен, например, для того чтобы назначать ведущие и ведомые реплики партиций при сбоях. У каждого брокера есть уникальный идентификатор (назначается автоматически или в конфиге - broker.id). Из основных настроек: num.partitions - дефолтное количество партиции в топике, log.dirs - куда сохраняем сообщения, log.retention.ms - сколько храним сообщения по времени, по умолчанию 7 дней, log.retention.bytes - сколько храним сообщения в разделе по байтам, message.max.bytes - какой максимум байт в сообщении брокер может принять. Сообщения удаляются сегментами. Закрытие сегмента определяется параметрами: log.segment.bytes и log.segment.ms.

## 3. Consumer